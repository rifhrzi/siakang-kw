# Weighted Round Robin Load Balancer Configuration
# Backend 1: weight=5, Backend 2: weight=3, Backend 3: weight=2

# Control Plane - Single backend for consistent state
upstream control_plane {
    server backend1:4000;
}

# Traffic Simulation - All backends for demo
upstream api_backends {
    # Weighted Round Robin - higher weight = more traffic
    server backend1:4000 weight=5;  # 50% of traffic
    server backend2:4000 weight=3;  # 30% of traffic
    server backend3:4000 weight=2;  # 20% of traffic
}

server {
    listen 80;
    server_name weightdemo.duckdns.org;

    # Serve static frontend
    root /usr/share/nginx/html;
    index index.html;

    # Frontend SPA routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Control Plane API - Single backend for state consistency
    # These endpoints manage server state and need consistent responses
    location ~ ^/api/(servers|traffic|reset|lb-toggle|lb-status|ab-test) {
        proxy_pass http://control_plane;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
        add_header X-Served-By "control-plane";
    }

    # Ping/Health API - Load Balanced for traffic demo
    location /api {
        proxy_pass http://api_backends;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Backend-Server $upstream_addr;
        proxy_cache_bypass $http_upgrade;
        
        # Add header to show which backend handled the request
        add_header X-Served-By $upstream_addr;
    }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;
}
